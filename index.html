<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumini - Social</title>
    <link rel="icon" href="https://i.ibb.co/XZVSKkBT/Screenshot-2025-11-10-174930-Photoroom.png" type="image/x-icon">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        lumini: {
                            blue: '#2563eb',
                            purple: '#9333ea',
                            dark: '#0f172a',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-short': 'bounceShort 0.5s ease-in-out 1',
                        'gradient-x': 'gradient-x 3s ease infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        bounceShort: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' },
                        },
                        'gradient-x': {
                            '0%, 100%': {
                                'background-size':'200% 200%',
                                'background-position': 'left center'
                            },
                            '50%': {
                                'background-size':'200% 200%',
                                'background-position': 'right center'
                            },
                        },
                    }
                }
            }
        }
    </script>

    <style>
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; font-weight: 500; font-size: 0.95rem; color: #475569; transition: all 0.2s; cursor: pointer; }
        .sidebar-link:hover { background-color: #e2e8f0; color: #1e293b; }
        .sidebar-link i { width: 24px; font-size: 1.2rem; }
        .sidebar-link.active { background-color: #eff6ff; color: #2563eb; font-weight: 600; }
        body { background-color: #f0f2f5; background-image: radial-gradient(circle at 10% 20%, rgba(37, 99, 235, 0.05) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(147, 51, 234, 0.05) 0%, transparent 20%); background-attachment: fixed; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .text-gradient { background: linear-gradient(to right, #2563eb, #9333ea); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .bg-gradient-lumini { background: linear-gradient(to right, #2563eb, #9333ea); }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        .msg-bubble { max-width: 80%; padding: 10px 15px; border-radius: 15px; position: relative; word-wrap: break-word; font-size: 0.9rem; }
        .msg-me { background: #2563eb; color: white; border-bottom-right-radius: 2px; margin-left: auto; }
        .msg-them { background: #f1f5f9; color: #334155; border-bottom-left-radius: 2px; margin-right: auto; }
        .msg-system { background: transparent; color: #64748b; font-size: 0.75rem; text-align: center; width: 100%; margin: 5px 0; font-style: italic; }
        .profile-tab { cursor: pointer; padding-bottom: 8px; color: #64748b; font-weight: 500; transition: all 0.2s; border-bottom: 2px solid transparent; }
        .profile-tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        .profile-tab:hover { color: #334155; }
        .notification-dot { position: absolute; top: -2px; right: -2px; width: 12px; height: 12px; background-color: #ef4444; border-radius: 50%; border: 2px solid white; display: none; }
        .shape-blob { position: absolute; filter: blur(70px); z-index: 0; opacity: 0.6; }
        .blob-1 { top: -10%; left: -10%; width: 300px; height: 300px; background: #9333ea; animation: pulse 8s infinite; }
        .blob-2 { bottom: -10%; right: -10%; width: 350px; height: 350px; background: #2563eb; animation: pulse 10s infinite reverse; }
        
        /* Online Status Dot */
        .status-dot-online { width: 12px; height: 12px; background-color: #22c55e; border: 2px solid white; border-radius: 50%; position: absolute; bottom: 0; right: 0; }
        
        /* Admin Badge Style */
        .admin-badge {
            background: linear-gradient(45deg, #ff0000, #ff8c00, #ffd700, #ff0000);
            background-size: 300% 300%;
            animation: gradient-x 4s ease infinite;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            margin-left: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 5px rgba(255, 0, 0, 0.3);
            vertical-align: middle;
        }
        
        /* Video Call Specific Styles */
        #localVideo { transform: scaleX(-1); } /* Mirror effect for self-view */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="text-slate-800 font-sans antialiased overflow-x-hidden selection:bg-blue-100 selection:text-blue-900">

    <div id="app" class="min-h-screen flex flex-col transition-all duration-500">
        <!-- RINGTONE AUDIO (Hidden) -->
        <audio id="call-ringtone" loop>
            <source src="https://assets.mixkit.co/active_storage/sfx/2330/2330-preview.m4a" type="audio/mp4">
            <source src="https://www.soundjay.com/phone/telephone-ring-03a.mp3" type="audio/mpeg">
        </audio>

        <!-- Navbar -->
        <nav class="glass fixed top-0 w-full z-50 h-16 transition-all duration-300 shadow-sm">
            <div class="max-w-[1440px] mx-auto h-full flex items-center justify-between px-4 lg:px-6">
                <!-- Logo -->
                <div class="flex items-center gap-2 cursor-pointer w-auto md:w-1/4" onclick="window.location.reload()">
                    <img src="https://i.ibb.co/XZVSKkBT/Screenshot-2025-11-10-174930-Photoroom.png" alt="Lumini Logo" class="w-9 h-9 object-contain">
                    <span class="font-heading font-bold text-2xl tracking-tight text-gradient hidden sm:block">Lumini</span>
                </div>

                <!-- Search Bar -->
                <div class="hidden md:flex relative items-center justify-center w-1/2">
                    <div class="relative w-full max-w-md">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                        <input id="global-search" type="text" placeholder="Search Lumini..." class="w-full bg-slate-100 border-transparent focus:bg-white focus:ring-2 focus:ring-blue-100 rounded-full pl-10 pr-4 py-2.5 text-sm outline-none transition-all text-slate-700" autocomplete="off" oninput="handleSearch(this.value)" onfocus="handleSearch(this.value)" onblur="setTimeout(()=>document.getElementById('search-dropdown').classList.add('hidden'), 200)">
                        <div id="search-dropdown" class="absolute top-14 left-0 w-full bg-white rounded-xl shadow-xl border border-slate-100 hidden overflow-hidden z-50"></div>
                    </div>
                </div>

                <!-- Right Menu -->
                <div class="flex items-center justify-end w-auto md:w-1/4 gap-2 sm:gap-4">
                    <button onclick="router('messaging')" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition-colors text-slate-600 relative">
                        <i class="fa-brands fa-facebook-messenger text-xl"></i>
                        <div id="chat-badge" class="notification-dot"></div>
                    </button>
                    
                    <div class="relative">
                        <button onclick="toggleNotificationDropdown()" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition-colors text-slate-600 relative">
                            <i class="fa-solid fa-bell text-xl"></i>
                            <div id="notification-badge" class="notification-dot"></div>
                        </button>
                        <div id="notification-dropdown" class="hidden absolute right-0 top-12 w-80 bg-white rounded-xl shadow-xl border border-slate-100 py-2 animate-fade-in z-50 max-h-96 overflow-y-auto custom-scrollbar">
                            <div class="px-4 py-2 border-b border-slate-100 flex justify-between items-center">
                                <h3 class="font-bold text-sm text-slate-800">Notifications</h3>
                                <button onclick="openClearNotifsModal()" class="text-xs text-red-500 hover:text-red-600 font-bold transition-colors">Clear All</button>
                            </div>
                            <div id="notification-list" class="p-2">
                                <p class="text-center text-xs text-slate-400 py-4">No new notifications.</p>
                            </div>
                        </div>
                    </div>

                    <div onclick="toggleProfileMenu()" class="ml-2 relative cursor-pointer">
                        <img id="nav-avatar" src="https://placehold.co/100x100?text=User" class="w-9 h-9 rounded-full ring-2 ring-white shadow-md object-cover hover:ring-blue-400 transition-all">
                        <div id="profile-menu" class="hidden absolute right-0 top-12 w-56 bg-white rounded-xl shadow-xl border border-slate-100 py-2 animate-fade-in z-50">
                            <div class="px-4 py-3 border-b border-slate-100 mb-2 flex items-center gap-3" onclick="viewMyProfile()">
                                <img id="menu-avatar-small" src="" class="w-10 h-10 rounded-full bg-slate-200">
                                <div><p id="menu-name" class="font-bold text-sm text-slate-800">Guest</p><p class="text-xs text-slate-500">See your profile</p></div>
                            </div>
                            <a href="#" onclick="openSettingsModal()" class="flex items-center gap-3 px-4 py-2 text-sm text-slate-600 hover:bg-slate-50"><i class="fa-solid fa-gear text-slate-400"></i> Settings & Privacy</a>
                            <a href="#" onclick="handleSignOut()" class="flex items-center gap-3 px-4 py-2 text-sm text-red-500 hover:bg-red-50"><i class="fa-solid fa-right-from-bracket"></i> Log Out</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Auth Overlay -->
        <div id="auth-overlay" class="fixed inset-0 bg-slate-50 z-[60] flex items-center justify-center p-4 md:p-8 transition-all duration-500 overflow-hidden">
            <div class="shape-blob blob-1 rounded-full"></div>
            <div class="shape-blob blob-2 rounded-full"></div>
            <div class="relative w-full max-w-5xl h-full md:h-[650px] bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/50 overflow-hidden flex flex-col md:flex-row">
                <div class="w-full md:w-1/2 bg-gradient-to-br from-blue-600 to-purple-700 p-8 md:p-12 flex flex-col justify-between relative overflow-hidden text-white">
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-8"><img src="https://i.ibb.co/XZVSKkBT/Screenshot-2025-11-10-174930-Photoroom.png" class="w-12 h-12 object-contain drop-shadow-lg"><span class="font-heading font-bold text-2xl tracking-tight">Lumini</span></div>
                        <h1 class="font-heading text-4xl md:text-5xl font-bold leading-tight mb-6">Connect. <br> Collaborate. <br> Create.</h1>
                        <p class="text-blue-100 text-lg font-light mb-8">Join the community where developers and creators build the future together.</p>
                    </div>
                </div>
                <div class="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center bg-white/50">
                    <div class="max-w-sm mx-auto w-full">
                        <h2 class="font-heading text-2xl font-bold text-slate-900 mb-2">Get Started</h2>
                        <p class="text-slate-500 mb-8 text-sm">Create an account or sign in.</p>
                        <div class="space-y-4">
                            <button onclick="handleGoogleAuth()" class="w-full bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 font-semibold py-3 rounded-xl flex items-center justify-center gap-3 transition-all shadow-sm"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Continue with Google</button>
                            <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-slate-200"></div><span class="flex-shrink mx-4 text-slate-400 text-xs font-semibold uppercase">Or with email</span><div class="flex-grow border-t border-slate-200"></div></div>
                            <input id="auth-email" type="email" placeholder="Email" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 transition-all">
                            <input id="auth-password" type="password" placeholder="Password" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 transition-all">
                            <button onclick="handleEmailAuth()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all">Sign In / Sign Up</button>
                        </div>
                        <p id="auth-error" class="text-red-500 text-xs mt-4 text-center hidden"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <main class="flex-grow pt-20 pb-6 px-4">
            <div class="max-w-[1440px] mx-auto grid grid-cols-1 md:grid-cols-12 gap-8">
                
                <!-- Left Sidebar -->
                <aside class="hidden md:block md:col-span-3 lg:col-span-3 space-y-2 sticky top-24 h-fit">
                    <div onclick="viewMyProfile()" class="sidebar-link mb-4 hover:bg-slate-200 rounded-xl transition-colors">
                        <img id="sidebar-mini-avatar" src="" class="w-9 h-9 rounded-full object-cover bg-slate-300">
                        <span id="sidebar-mini-name" class="font-bold text-slate-800 text-sm">Guest</span>
                    </div>
                    <div onclick="router('feed')" class="sidebar-link active" id="nav-link-feed"><i class="fa-solid fa-house text-blue-500"></i> <span>Home</span></div>
                    <div onclick="viewMyProfile()" class="sidebar-link" id="nav-link-profile"><i class="fa-solid fa-user text-blue-500"></i> <span>Profile</span></div>
                    <div onclick="router('network')" class="sidebar-link" id="nav-link-network"><i class="fa-solid fa-user-group text-blue-500"></i> <span>Network</span></div>
                    <div onclick="router('messaging')" class="sidebar-link" id="nav-link-messaging"><i class="fa-solid fa-comment-dots text-blue-500"></i> <span>Messages</span></div>
                    <div onclick="router('saved')" class="sidebar-link" id="nav-link-saved"><i class="fa-solid fa-bookmark text-purple-600"></i> <span>Saved</span></div>
                    <div class="border-t border-slate-300 my-2 mx-2"></div>
                    <div onclick="window.open('https://luminiroyalacademy.github.io/Lumini/', '_blank')" class="sidebar-link"><i class="fa-solid fa-book-open text-slate-600"></i> <span>Documentation</span></div>
                    <div onclick="openSettingsModal()" class="sidebar-link"><i class="fa-solid fa-gear text-slate-600"></i> <span>Settings</span></div>
                    <div class="mt-8 px-4 text-[10px] text-slate-400 leading-relaxed">Lumini 漏 2025 路 Privacy 路 Terms 路 Cookies 路 More</div>
                </aside>

                <!-- Center Content -->
                <section id="main-container" class="col-span-12 md:col-span-9 lg:col-span-6">
                    
                    <!-- View: Feed -->
                    <div id="view-feed" class="view-section space-y-6">
                        <div class="glass-card rounded-2xl p-4 bg-white">
                            <div class="flex gap-4 mb-4">
                                <img id="composer-avatar" src="https://placehold.co/100x100?text=User" class="w-12 h-12 rounded-full bg-slate-100 object-cover">
                                <div onclick="openPostModal()" class="flex-grow bg-slate-100 hover:bg-slate-200 rounded-full px-5 py-3 cursor-pointer transition-colors text-slate-500 text-sm font-medium flex items-center">What's on your mind, <span id="composer-name-placeholder" class="ml-1">User</span>?</div>
                            </div>
                            <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                                <div class="flex gap-1">
                                    <button onclick="openPostModal('image')" class="px-4 py-2 text-slate-500 hover:bg-slate-50 rounded-lg transition-colors text-sm font-medium flex items-center gap-2"><i class="fa-solid fa-image text-green-500"></i> Photo/Video</button>
                                    <button onclick="openPostModal('project')" class="px-4 py-2 text-slate-500 hover:bg-slate-50 rounded-lg transition-colors text-sm font-medium flex items-center gap-2"><i class="fa-solid fa-rocket text-blue-500"></i> Project</button>
                                </div>
                            </div>
                        </div>
                        <div id="feed-stream" class="space-y-5 pb-20"><div class="text-center py-12"><i class="fa-solid fa-circle-notch fa-spin text-blue-500 text-2xl"></i></div></div>
                    </div>

                    <!-- View: Saved -->
                    <div id="view-saved" class="view-section hidden space-y-6">
                        <div class="glass-card rounded-2xl p-6 bg-white mb-4">
                            <h2 class="font-heading font-bold text-2xl text-slate-800 flex items-center gap-3"><i class="fa-solid fa-bookmark text-purple-600"></i> Saved Posts</h2>
                            <p class="text-slate-500 text-sm mt-1">Only you can see what you've saved.</p>
                        </div>
                        <div id="saved-posts-stream" class="space-y-5 pb-20"></div>
                    </div>

                    <!-- View: Network -->
                    <div id="view-network" class="view-section hidden space-y-4">
                        <div class="glass-card rounded-2xl p-6 mb-6 bg-white">
                            <h2 class="font-heading font-bold text-2xl text-slate-800">Grow your Network</h2>
                            <p class="text-slate-500 text-sm mt-1">Find collaborators. <span class="text-xs text-slate-400">(Real users appear here)</span></p>
                        </div>
                        <div id="network-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                    </div>

                    <!-- View: Profile -->
                    <div id="view-profile" class="view-section hidden space-y-6 animate-fade-in">
                        <div class="glass-card rounded-2xl overflow-hidden bg-white">
                            <div class="h-40 bg-gradient-to-r from-blue-500 to-purple-600 relative">
                                <button onclick="router('feed')" class="absolute top-4 left-4 bg-black/30 hover:bg-black/50 text-white px-4 py-2 rounded-full backdrop-blur transition-all text-sm font-bold"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
                            </div>
                            <div class="px-6 pb-6 relative">
                                <div class="flex flex-col sm:flex-row items-end -mt-12 mb-4 gap-4">
                                    <div class="relative">
                                        <div class="w-32 h-32 rounded-full border-4 border-white shadow-lg bg-white overflow-hidden relative z-10">
                                            <img id="profile-page-avatar" src="" class="w-full h-full object-cover">
                                        </div>
                                    </div>
                                    
                                    <div class="flex-grow mb-2 text-center sm:text-left">
                                        <h2 id="profile-page-name" class="font-heading font-bold text-3xl text-slate-800">User Name</h2>
                                        <p id="profile-page-headline" class="text-slate-500 font-medium text-sm">Headline</p>
                                        
                                        <!-- Followers/Following UI -->
                                        <div class="flex gap-4 text-sm mt-2 text-slate-600">
                                            <span class="cursor-pointer hover:text-blue-600 transition-colors" onclick="openFollowModal('followers')"><b id="profile-followers-count" class="text-slate-900">0</b> Followers</span>
                                            <span class="cursor-pointer hover:text-blue-600 transition-colors" onclick="openFollowModal('following')"><b id="profile-following-count" class="text-slate-900">0</b> Following</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex gap-2 mb-3">
                                         <button id="edit-profile-btn" onclick="openEditProfileModal()" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-bold text-sm hover:bg-slate-300 transition-all hidden flex items-center gap-2">
                                            <i class="fa-solid fa-pen"></i> Edit Profile
                                        </button>
                                         <button id="follow-btn" onclick="toggleFollow(window.currentViewedUid)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 transition-all shadow-md flex items-center gap-2 hidden">
                                            <i class="fa-solid fa-user-plus"></i> <span>Follow</span>
                                        </button>
                                        <button id="profile-chat-btn" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-bold text-sm hover:bg-slate-300 transition-all flex items-center gap-2 hidden">
                                            <i class="fa-brands fa-facebook-messenger"></i> Message
                                        </button>
                                    </div>
                                    <div id="admin-controls-container"></div>
                                </div>
                                
                                <div class="border-t border-slate-200 pt-4 flex gap-8 text-sm font-semibold">
                                    <div onclick="switchProfileTab('posts')" id="tab-posts" class="profile-tab active">Posts</div>
                                    <div onclick="switchProfileTab('about')" id="tab-about" class="profile-tab">About</div>
                                    <div onclick="switchProfileTab('saved')" id="tab-saved" class="profile-tab hidden">Saved</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-1 space-y-4">
                                <div class="glass-card rounded-2xl p-5 bg-white">
                                    <h3 class="font-bold text-slate-800 mb-3 text-lg">Intro</h3>
                                    <p id="profile-page-bio" class="text-sm text-slate-600 mb-4 leading-relaxed whitespace-pre-line"></p>
                                    <div class="text-xs text-slate-400 flex items-center gap-2 mb-2"><i class="fa-solid fa-clock"></i> Joined <span id="profile-join-date">...</span></div>
                                </div>
                            </div>
                            
                            <div class="md:col-span-2">
                                <div id="profile-content-posts" class="space-y-6"></div>
                                <div id="profile-content-about" class="hidden glass-card rounded-2xl p-6 bg-white">
                                    <h3 class="font-bold text-xl mb-4">Full Bio</h3>
                                    <p id="profile-full-bio" class="text-slate-700 leading-relaxed whitespace-pre-line"></p>
                                </div>
                                <div id="profile-content-saved" class="hidden space-y-6"></div>
                            </div>
                        </div>
                    </div>

                    <!-- View: Messaging -->
                    <div id="view-messaging" class="view-section hidden h-[calc(100vh-140px)] glass-card rounded-2xl flex overflow-hidden border border-slate-200">
                        
                        <div id="msg-list-col" class="w-full md:w-1/3 border-r border-slate-100 bg-slate-50/50 flex flex-col">
                            <div class="p-4 border-b border-slate-100"><h3 class="font-heading font-bold text-slate-800">Chats</h3></div>
                            <div id="chat-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar"></div>
                        </div>
                        
                        <div id="msg-chat-col" class="hidden md:flex w-full md:w-2/3 flex-col bg-white relative">
                            <div id="chat-header" class="h-16 border-b border-slate-100 flex items-center px-4 justify-between bg-white/80 backdrop-blur">
                                <div class="flex items-center gap-3">
                                    <button onclick="backToChatList()" class="md:hidden text-slate-500 hover:bg-slate-100 w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-arrow-left"></i></button>
                                    <span class="font-bold text-slate-400 text-sm">Select a conversation</span>
                                </div>
                                <div class="flex gap-2">
                                    <button id="start-audio-call-btn" onclick="initiateCall('audio')" class="hidden text-slate-500 hover:text-green-600 w-10 h-10 rounded-full hover:bg-green-50 flex items-center justify-center transition-all" title="Start Audio Call">
                                        <i class="fa-solid fa-phone text-lg"></i>
                                    </button>
                                    <button id="start-video-call-btn" onclick="initiateCall('video')" class="hidden text-blue-500 hover:text-blue-600 w-10 h-10 rounded-full hover:bg-blue-50 flex items-center justify-center transition-all" title="Start Video Call">
                                        <i class="fa-solid fa-video text-lg"></i>
                                    </button>
                                    <button id="delete-chat-btn" onclick="deleteChat()" class="hidden text-red-400 hover:text-red-600 w-10 h-10 rounded-full hover:bg-red-50 flex items-center justify-center transition-all" title="Delete Conversation">
                                        <i class="fa-solid fa-trash text-lg"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50/30 custom-scrollbar flex flex-col"><div class="flex h-full items-center justify-center text-slate-400 text-sm flex-col gap-2"><i class="fa-regular fa-paper-plane text-4xl mb-2 opacity-50"></i><p>Select a user to start chatting.</p></div></div>
                            <div class="p-4 border-t border-slate-100 bg-white">
                                <form id="message-form" class="flex gap-2" onsubmit="sendMessage(event)">
                                    <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 bg-slate-100 border-transparent focus:bg-white focus:border-blue-500 rounded-full px-4 py-3 outline-none transition-all text-sm" disabled>
                                    <button id="message-send-btn" type="submit" class="text-blue-600 text-xl px-2 hover:text-blue-700 transition-colors disabled:opacity-50" disabled><i class="fa-solid fa-paper-plane"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Right Sidebar -->
                <aside id="right-sidebar" class="hidden lg:block lg:col-span-3 space-y-6 sticky top-24 h-fit">
                    <div class="glass-card rounded-2xl p-5 bg-white">
                        <h3 class="font-heading font-bold text-slate-500 text-sm mb-4 uppercase">Documentation</h3>
                        <div onclick="window.open('https://luminiroyalacademy.github.io/Lumini/', '_blank')" class="flex items-start gap-3 mb-4 cursor-pointer hover:bg-slate-50 p-2 rounded-lg transition group">
                            <div class="w-20 h-20 bg-slate-200 rounded-lg overflow-hidden flex-shrink-0 relative">
                                <img src="https://i.postimg.cc/pL3qStZD/Screenshot-2025-11-22-212117.png" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            </div>
                            <div>
                                <p class="font-bold text-sm text-slate-800 group-hover:text-blue-600 transition-colors">Project Lumini: Documentation</p>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 bg-white">
                        <h3 class="font-heading font-bold text-slate-500 text-sm mb-4 uppercase">Community Highlights</h3>
                        <div id="lumini-news-content"><p class="text-xs text-gray-400">Trending discussions will appear here.</p></div>
                    </div>
                </aside>
            </div>
        </main>

        <!-- Modals -->

        <!-- REPORT POST MODAL (NEW) -->
        <div id="report-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800"><i class="fa-solid fa-flag text-orange-500 mr-2"></i>Report Violation</h3>
                    <button onclick="closeReportModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <p class="text-sm text-slate-600">Please help us understand why this post is inappropriate. A report will be generated and sent to our admin team via email.</p>
                    <textarea id="report-reason" rows="4" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-orange-500 text-sm" placeholder="Reason for reporting (e.g., Spam, Harassment, Misinformation)..."></textarea>
                </div>
                <div class="p-5 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                    <button onclick="closeReportModal()" class="px-4 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold text-sm">Cancel</button>
                    <button onclick="submitReport()" class="px-6 py-2 rounded-lg bg-orange-500 hover:bg-orange-600 text-white font-bold text-sm shadow-md transition-colors">Submit Report</button>
                </div>
            </div>
        </div>

        <!-- CLEAR NOTIFICATIONS CONFIRM MODAL (NEW) -->
        <div id="clear-notifs-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up text-center">
                 <div class="p-6">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-trash-can text-2xl text-red-500"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Clear All Notifications?</h3>
                    <p class="text-slate-500 text-sm mb-6">This action cannot be undone. All your current notifications will be permanently removed.</p>
                    <div class="flex gap-3">
                        <button onclick="closeClearNotifsModal()" class="flex-1 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold text-sm transition-colors">Cancel</button>
                        <button onclick="executeClearNotifs()" class="flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold text-sm shadow-lg shadow-red-200 transition-colors">Yes, Clear All</button>
                    </div>
                 </div>
            </div>
        </div>
        
        <!-- ADMIN BAN MODAL (NEW) -->
        <div id="ban-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4 animate-fade-in">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
                <div class="p-6 text-center">
                    <div id="ban-icon-container" class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                        <i id="ban-icon" class="fa-solid fa-gavel text-2xl text-red-600"></i>
                    </div>
                    <h3 id="ban-modal-title" class="text-xl font-bold text-slate-800 mb-2">Ban User?</h3>
                    <p id="ban-modal-desc" class="text-slate-500 text-sm mb-6">They will be immediately logged out and lose access.</p>
                    <div class="flex gap-3">
                        <button onclick="closeBanModal()" class="flex-1 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold text-sm transition-colors">Cancel</button>
                        <button id="confirm-ban-btn" onclick="executeBan()" class="flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold text-sm shadow-lg shadow-red-200 transition-colors">Ban User</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOLLOW LIST MODAL -->
        <div id="follow-list-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4">
             <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up h-[500px] flex flex-col">
                 <div class="flex justify-between items-center p-4 border-b border-slate-100">
                     <h3 id="follow-list-title" class="font-heading font-bold text-lg text-slate-800">Followers</h3>
                     <button onclick="document.getElementById('follow-list-modal').classList.add('hidden')" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                 </div>
                 <div id="follow-list-content" class="flex-1 overflow-y-auto custom-scrollbar p-2"></div>
             </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settings-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[85] hidden flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800">Settings & Privacy</h3>
                    <button onclick="closeSettingsModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 space-y-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Display Name (Username)</label>
                        <input id="settings-username" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500">
                    </div>
                    <div class="border-t border-slate-100 pt-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Account Security</label>
                        <button onclick="resetPassword()" class="w-full flex items-center justify-center gap-2 p-3 border border-red-200 text-red-600 rounded-xl hover:bg-red-50 transition-colors font-semibold">
                            <i class="fa-solid fa-key"></i> Reset Password via Email
                        </button>
                    </div>
                </div>
                <div class="p-5 bg-slate-50 border-t border-slate-100 flex justify-end">
                    <button onclick="saveSettings()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition-colors">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <div id="edit-profile-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800">Edit Profile</h3>
                    <button onclick="closeEditProfileModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex justify-center mb-4">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('pfp-upload-modal').click()">
                            <img id="edit-modal-avatar" src="https://placehold.co/200x200" class="w-24 h-24 rounded-full border-4 border-slate-100 object-cover">
                            <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fa-solid fa-camera text-white text-2xl"></i>
                            </div>
                            <input type="file" id="pfp-upload-modal" class="hidden" accept="image/*" onchange="handlePfpChange(this)">
                        </div>
                    </div>
                    <div class="text-center text-xs text-slate-400 mb-4">Click picture to change</div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Headline</label>
                        <input id="edit-headline" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500" placeholder="Short description">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bio</label>
                        <textarea id="edit-bio" rows="4" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500" placeholder="Tell us about yourself..."></textarea>
                    </div>
                </div>
                <div class="p-5 bg-slate-50 border-t border-slate-100 flex justify-end">
                    <button onclick="saveProfileData()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition-colors">Save Profile</button>
                </div>
            </div>
        </div>

        <!-- Post Modal -->
        <div id="post-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
            <div class="relative bg-white w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
                <div class="relative flex justify-between items-center p-4 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800 flex-grow text-center" id="modal-title">Create Post</h3>
                    <button onclick="closePostModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center absolute right-4"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-4">
                    <div class="flex gap-3 mb-4">
                        <img id="modal-avatar" src="https://placehold.co/100x100?text=User" class="w-10 h-10 rounded-full">
                        <div><h4 id="modal-name" class="font-bold text-slate-800 text-sm">Guest</h4><select id="post-type-select" class="text-xs bg-slate-100 border-none rounded-md px-2 py-1 outline-none mt-0.5 font-medium text-slate-600"><option value="regular">Public</option><option value="project">Project</option></select></div>
                    </div>
                    <textarea id="post-input" rows="4" class="w-full resize-none outline-none text-slate-700 placeholder-slate-400 text-lg" placeholder="What's on your mind?"></textarea>
                    <div id="attachment-preview" class="hidden mt-2 relative group"><img id="preview-img" src="" class="max-h-48 rounded-lg border border-slate-200"><button onclick="clearAttachment()" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-black"><i class="fa-solid fa-xmark"></i></button></div>
                    <!-- Tagged Users Display -->
                    <div id="tagged-users-display" class="hidden mt-2 flex flex-wrap gap-2"></div>
                    
                    <div id="project-tags-input" class="hidden mt-3 pt-3 border-t border-dashed border-slate-200"><label class="text-xs font-bold text-slate-500 uppercase mb-1">Tags (Comma separated)</label><input id="tags-input" type="text" class="w-full text-sm bg-slate-50 p-2 rounded-lg outline-none" placeholder="e.g. #javascript, #design"></div>
                </div>
                <div class="px-4 pb-4 flex justify-between items-center relative">
                    <span class="text-sm font-bold text-slate-700">Add to your post</span>
                    <div class="flex gap-3 text-xl">
                        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleFileSelect(this)">
                        <i class="fa-solid fa-image text-green-500 cursor-pointer hover:bg-slate-100 p-1 rounded" onclick="document.getElementById('file-input').click()"></i>
                        <i class="fa-solid fa-user-tag text-purple-500 cursor-pointer hover:bg-slate-100 p-1 rounded" onclick="toggleTagUserPicker()"></i>
                        <i class="fa-solid fa-tag text-blue-500 cursor-pointer hover:bg-slate-100 p-1 rounded" onclick="toggleTagPicker()"></i>
                        <i class="fa-solid fa-face-smile text-yellow-500 cursor-pointer hover:bg-slate-100 p-1 rounded" onclick="toggleEmojiPicker()"></i>
                    </div>
                </div>
                <div class="p-4 pt-0"><button id="post-submit-btn" onclick="submitPost()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition-colors">Post</button></div>
                
                <div id="emoji-picker" class="hidden absolute bottom-20 right-8 bg-white border border-slate-200 shadow-xl rounded-lg p-2 grid grid-cols-5 gap-2 w-48 z-50">
                    <span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center" onclick="insertEmoji('わ')">わ</span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center" onclick="insertEmoji('')"></span>
                </div>
                
                <div id="tag-picker" class="hidden absolute bottom-20 right-20 bg-white border border-slate-200 shadow-xl rounded-lg p-2 w-48 z-50 max-h-40 overflow-y-auto custom-scrollbar">
                   <div id="tag-list" class="space-y-1"></div>
                </div>
                
                <div id="user-tag-picker" class="hidden absolute bottom-20 right-32 bg-white border border-slate-200 shadow-xl rounded-lg p-2 w-56 z-50 max-h-48 overflow-y-auto custom-scrollbar">
                   <div id="user-tag-list" class="space-y-1"></div>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div id="delete-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[90] hidden flex items-center justify-center p-4 transition-all duration-300 opacity-0">
             <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full transform scale-95 transition-all duration-300 text-center">
                 <i class="fa-solid fa-triangle-exclamation text-4xl text-red-500 mb-4"></i>
                 <h3 class="font-bold text-lg mb-2">Delete Post?</h3>
                 <p class="text-slate-500 text-sm mb-6">This action cannot be undone.</p>
                 <div class="flex gap-3 justify-center">
                     <button onclick="closeDeleteModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium">Cancel</button>
                     <button onclick="executeDelete()" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium">Delete</button>
                 </div>
             </div>
        </div>

        <!-- INCOMING CALL MODAL -->
        <div id="incoming-call-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[100] hidden flex items-center justify-center p-4 animate-fade-in">
            <div class="bg-white/10 border border-white/20 p-8 rounded-3xl shadow-2xl backdrop-blur-xl text-center max-w-sm w-full">
                <div class="w-24 h-24 bg-white/20 rounded-full mx-auto flex items-center justify-center mb-6 animate-pulse-slow">
                    <i class="fa-solid fa-phone-volume text-4xl text-white"></i>
                </div>
                <h3 id="caller-name-display" class="text-2xl font-bold text-white mb-2">Incoming Call...</h3>
                <p class="text-blue-100 text-sm mb-8">Someone is trying to reach you.</p>
                <div class="flex gap-4 justify-center">
                    <button onclick="declineCall()" class="w-14 h-14 rounded-full bg-red-500 hover:bg-red-600 text-white flex items-center justify-center transition-all shadow-lg shadow-red-500/30 transform hover:scale-110"><i class="fa-solid fa-phone-slash text-xl"></i></button>
                    <button onclick="answerCall()" class="w-14 h-14 rounded-full bg-green-500 hover:bg-green-600 text-white flex items-center justify-center transition-all shadow-lg shadow-green-500/30 transform hover:scale-110 animate-bounce-short"><i class="fa-solid fa-phone text-xl"></i></button>
                </div>
            </div>
        </div>

        <!-- ACTIVE CALL INTERFACE -->
        <div id="call-interface" class="fixed inset-0 bg-slate-900 z-[100] hidden flex flex-col">
            <!-- Header -->
            <div class="absolute top-0 left-0 w-full p-4 z-20 flex justify-between items-center bg-gradient-to-b from-black/50 to-transparent">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                    <span id="call-status-text" class="text-white font-medium text-sm shadow-black drop-shadow-md">Connecting...</span>
                </div>
                <i id="call-icon-indicator" class="fa-solid fa-video text-white/50"></i>
            </div>
            
            <!-- Video Container -->
            <div class="relative flex-1 bg-black flex items-center justify-center overflow-hidden">
                <!-- Remote Video (Full) -->
                <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
                
                <!-- Audio Placeholder -->
                <div id="audio-call-placeholder" class="absolute inset-0 flex items-center justify-center bg-slate-800 hidden">
                    <div class="text-center">
                        <div class="w-32 h-32 bg-slate-700 rounded-full flex items-center justify-center mb-4 mx-auto animate-pulse">
                            <i class="fa-solid fa-user text-5xl text-slate-400"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white">Voice Call</h3>
                    </div>
                </div>

                <!-- Local Video (PIP) -->
                <div class="absolute bottom-24 right-4 w-32 h-48 bg-slate-800 rounded-xl overflow-hidden shadow-2xl border-2 border-white/20">
                    <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover"></video>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="h-24 bg-slate-900/80 backdrop-blur flex items-center justify-center gap-6 pb-safe">
                <button id="btn-toggle-mic" onclick="toggleAudio()" class="w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 text-white transition-all flex items-center justify-center"><i class="fa-solid fa-microphone"></i></button>
                <button onclick="endCall()" class="w-16 h-16 rounded-full bg-red-600 hover:bg-red-700 text-white shadow-lg shadow-red-600/30 transition-all flex items-center justify-center transform hover:scale-105"><i class="fa-solid fa-phone-slash text-2xl"></i></button>
                <button id="btn-toggle-cam" onclick="toggleVideo()" class="w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 text-white transition-all flex items-center justify-center"><i class="fa-solid fa-video"></i></button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, sendPasswordResetEmail, updateProfile, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, increment, setDoc, getDoc, getDocs, arrayUnion, arrayRemove, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- CONFIGURATION ---
        const luminiConfig = {
          apiKey: "AIzaSyDtV1VuCnNCDeuHwGX4ZUCG0WMJM82-hBY",
          authDomain: "luminix-bcc28.firebaseapp.com",
          databaseURL: "https://luminix-bcc28-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "luminix-bcc28",
          storageBucket: "luminix-bcc28.firebasestorage.app",
          messagingSenderId: "217255412785",
          appId: "1:217255412785:web:dccb64a43aa83c6b234110",
          measurementId: "G-TKJELBK1F5"
        };
        
        // Initialize Firebase
        const app = initializeApp(luminiConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "lumini_v1";

        // ADMIN
        const ADMIN_EMAIL = "tenzing.jangseld2023@academy.bt";

        // State
        window.currentUser = null;
        window.allChats = []; 
        window.currentViewedUid = null;
        let unsubscribePosts = null;
        let unsubscribeChatList = null;
        let unsubscribeMessages = null;
        let unsubscribeNotifications = null;
        let unsubscribeUsers = null;
        let currentChatId = null;
        let mySavedPosts = [];
        let allPostsCache = []; 
        let allUsersCache = [];
        let allNotifications = [];
        let postToDeleteId = null; // NEW: Track owner for admin notification
        let editModeId = null;
        let currentAttachment = null;
        window.taggedUsers = [];
        
        // --- ADMIN MODAL LOGIC ---
        let userToBanId = null;
        let userToBanCurrentStatus = false;

        window.toggleBan = (uid, currentStatus) => {
            userToBanId = uid;
            userToBanCurrentStatus = currentStatus;
            
            const modal = document.getElementById('ban-modal');
            const title = document.getElementById('ban-modal-title');
            const desc = document.getElementById('ban-modal-desc');
            const btn = document.getElementById('confirm-ban-btn');
            const iconContainer = document.getElementById('ban-icon-container');
            const icon = document.getElementById('ban-icon');

            if (currentStatus) {
                // Unban State
                title.innerText = "Unban User?";
                desc.innerText = "They will regain access to Lumini immediately.";
                btn.innerText = "Unban User";
                btn.classList.remove('bg-red-600', 'hover:bg-red-700', 'shadow-red-200');
                btn.classList.add('bg-green-600', 'hover:bg-green-700', 'shadow-green-200');
                iconContainer.classList.remove('bg-red-100');
                iconContainer.classList.add('bg-green-100');
                icon.classList.remove('text-red-600', 'fa-gavel');
                icon.classList.add('text-green-600', 'fa-unlock');
            } else {
                // Ban State
                title.innerText = "Ban User?";
                desc.innerText = "They will be immediately logged out and lose access.";
                btn.innerText = "Ban User";
                btn.classList.remove('bg-green-600', 'hover:bg-green-700', 'shadow-green-200');
                btn.classList.add('bg-red-600', 'hover:bg-red-700', 'shadow-red-200');
                iconContainer.classList.remove('bg-green-100');
                iconContainer.classList.add('bg-red-100');
                icon.classList.remove('text-green-600', 'fa-unlock');
                icon.classList.add('text-red-600', 'fa-gavel');
            }
            
            modal.classList.remove('hidden');
        };

        window.closeBanModal = () => {
            document.getElementById('ban-modal').classList.add('hidden');
            userToBanId = null;
        };

        window.executeBan = async () => {
            if (!userToBanId) return;
            
            const newStatus = !userToBanCurrentStatus;
            
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', userToBanId), {
                    isBanned: newStatus
                });
                closeBanModal();
                // Refresh the profile view to show updated button state
                viewProfile(userToBanId);
            } catch (e) {
                console.error("Error banning user:", e);
                alert("Failed to update ban status.");
            }
        };

        // --- CALL STATE ---
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let currentCallId = null;
        let unsubscribeCall = null;
        let incomingCallData = null;
        let callType = 'video';
        let iceCandidateQueue = [];
        
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ]
        };

        // Auth Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                
                // BAN CHECK
                const userDirRef = doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', user.uid);
                const userDirSnap = await getDoc(userDirRef);
                if (userDirSnap.exists() && userDirSnap.data().isBanned) {
                    await signOut(auth);
                    document.getElementById('auth-error').innerText = "Account Banned: Access revoked by Admin.";
                    document.getElementById('auth-error').classList.remove('hidden');
                    document.getElementById('auth-overlay').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                    return;
                }

                // Admin Check: Mark user as admin in directory for easy lookup
                if (user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                     if (userDirSnap.exists()) {
                         await updateDoc(userDirRef, { isAdmin: true });
                     }
                }

                currentUser = user;
                window.currentUser = user;
                
                if(!user.displayName) {
                    const name = user.email.split('@')[0];
                    await updateProfile(user, { displayName: name });
                }
                
                const defaultAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}&background=random`;
                if(!user.photoURL) {
                     await updateProfile(user, { photoURL: defaultAvatar });
                }

                if (!userDirSnap.exists()) {
                    await setDoc(userDirRef, {
                        name: user.displayName || user.email.split('@')[0],
                        photoURL: user.photoURL || defaultAvatar,
                        headline: "",
                        id: user.uid,
                        createdAt: serverTimestamp()
                    });
                }
                
                const userProfileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
                const userProfileSnap = await getDoc(userProfileRef);
                if(!userProfileSnap.exists()) {
                    await setDoc(userProfileRef, {
                        headline: "",
                        bio: "",
                        savedPosts: [],
                        followers: [],
                        following: []
                    });
                }
                
                document.getElementById('auth-overlay').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => document.getElementById('auth-overlay').classList.add('hidden'), 500);

                loadData();
            } else {
                currentUser = null;
                window.currentUser = null;
                document.getElementById('auth-overlay').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            }
        });

        // --- NEW: Follow Logic ---
        window.toggleFollow = async (targetUid) => {
            if(!currentUser || !targetUid || targetUid === currentUser.uid) return;

            const myRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
            const targetRef = doc(db, 'artifacts', appId, 'users', targetUid, 'profile', 'main');
            
            // Check current status first
            const myDoc = await getDoc(myRef);
            const myData = myDoc.data();
            const isFollowing = myData.following && myData.following.includes(targetUid);

            const btn = document.getElementById('follow-btn');
            const btnText = btn.querySelector('span');
            
            if(isFollowing) {
                // Unfollow
                await updateDoc(myRef, { following: arrayRemove(targetUid) });
                await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
                btnText.innerText = "Follow";
                btn.classList.remove('bg-slate-200', 'text-slate-700');
                btn.classList.add('bg-blue-600', 'text-white');
            } else {
                // Follow
                await updateDoc(myRef, { following: arrayUnion(targetUid) });
                await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
                btnText.innerText = "Unfollow";
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-slate-200', 'text-slate-700');
                
                // Send Notification
                await addDoc(collection(db, 'artifacts', appId, 'users', targetUid, 'notifications'), {
                    type: 'follow',
                    fromUid: currentUser.uid,
                    fromName: currentUser.displayName,
                    read: false,
                    createdAt: serverTimestamp()
                });
            }
            // Refresh view to update counts
            viewProfile(targetUid);
        };

        window.openFollowModal = async (type) => {
            const uid = window.currentViewedUid || currentUser.uid;
            const modal = document.getElementById('follow-list-modal');
            const title = document.getElementById('follow-list-title');
            const content = document.getElementById('follow-list-content');
            
            title.innerText = type === 'followers' ? 'Followers' : 'Following';
            content.innerHTML = '<div class="flex justify-center p-4"><i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i></div>';
            modal.classList.remove('hidden');
            
            // Fetch list
            const docRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'main');
            const docSnap = await getDoc(docRef);
            
            if(docSnap.exists()) {
                const data = docSnap.data();
                const listIds = data[type] || [];
                
                if(listIds.length === 0) {
                    content.innerHTML = '<p class="text-center text-slate-400 py-4 text-sm">No users found.</p>';
                    return;
                }
                
                // Map IDs to User Objects
                const userPromises = listIds.map(id => getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', id)));
                const userDocs = await Promise.all(userPromises);
                
                content.innerHTML = userDocs.map(d => {
                    if(!d.exists()) return '';
                    const u = d.data();
                    return `
                    <div class="flex items-center gap-3 p-3 hover:bg-slate-50 cursor-pointer rounded-lg" onclick="document.getElementById('follow-list-modal').classList.add('hidden'); viewProfile('${u.id}')">
                        <img src="${u.photoURL}" class="w-10 h-10 rounded-full bg-slate-200 object-cover">
                        <div>
                            <p class="font-bold text-sm text-slate-800">${u.name}</p>
                            <p class="text-xs text-slate-500 truncate w-48">${u.headline || ''}</p>
                        </div>
                    </div>`;
                }).join('');
            } else {
                 content.innerHTML = '<p class="text-center text-slate-400 py-4 text-sm">Error loading list.</p>';
            }
        };


        // --- CALL LOGIC ---
        function monitorIncomingCalls() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'calls'), orderBy('createdAt', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    if (change.type === "added" && data.callee === currentUser.uid && data.status === 'offering') {
                        showIncomingCall(change.doc.id, data);
                    }
                });
            });
        }
        
        function showIncomingCall(callId, data) {
            currentCallId = callId;
            incomingCallData = data;
            const type = data.callType || 'video';
            callType = type;
            document.getElementById('caller-name-display').innerText = (data.callerName || "Someone") + ` is calling (${type})...`;
            document.getElementById('incoming-call-modal').classList.remove('hidden');
            
            // PLAY RINGTONE with user interaction fallback
            const r = document.getElementById('call-ringtone');
            r.currentTime = 0;
            const playPromise = r.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Autoplay blocked. User needs to interact with DOM first.");
                });
            }
        }

        window.declineCall = async () => {
            document.getElementById('incoming-call-modal').classList.add('hidden');
            document.getElementById('call-ringtone').pause();
            if(incomingCallData) {
                logSystemMessage(` Missed ${incomingCallData.callType || 'video'} call`, incomingCallData.caller);
            }
            currentCallId = null;
            incomingCallData = null;
        };

        window.answerCall = async () => {
            document.getElementById('incoming-call-modal').classList.add('hidden');
            document.getElementById('call-ringtone').pause();
            setupCallInterface(callType);
            document.getElementById('call-status-text').innerText = "Connecting...";

            const callId = currentCallId;
            const offer = incomingCallData.offer;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: callType === 'video', audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                // Important: Setup remote stream properly
                const remoteStream = new MediaStream();
                document.getElementById('remoteVideo').srcObject = remoteStream;

                peerConnection = new RTCPeerConnection(servers);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                // Improved stream handling
                peerConnection.ontrack = (event) => {
                    event.streams[0].getTracks().forEach(track => {
                        remoteStream.addTrack(track);
                    });
                };

                peerConnection.onicecandidate = async (event) => {
                    if(event.candidate) {
                        const calleeCandidatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls', callId, 'calleeCandidates');
                        await addDoc(calleeCandidatesRef, event.candidate.toJSON());
                    }
                };

                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                const callDoc = doc(db, 'artifacts', appId, 'public', 'data', 'calls', callId);
                await updateDoc(callDoc, { answer: { type: answer.type, sdp: answer.sdp }, status: 'answered' });

                const callerCandidatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls', callId, 'callerCandidates');
                onSnapshot(callerCandidatesRef, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const candidate = new RTCIceCandidate(change.doc.data());
                            peerConnection.addIceCandidate(candidate).catch(e => console.error("Error adding candidate", e));
                        }
                    });
                });
                
                onSnapshot(callDoc, (snap) => {
                    if(snap.exists() && snap.data().status === 'ended') endCallCleanup();
                });
            } catch (err) {
                console.error("Error answering call:", err);
                alert("Call Failed: Could not access camera/microphone or connect. Check permissions.");
                endCallCleanup();
            }
        };

        window.initiateCall = async (type = 'video') => {
            if(!currentChatId) return;
            const parts = currentChatId.split('_');
            const targetUid = parts.find(id => id !== currentUser.uid);
            if(!targetUid) return alert("Cannot call this user.");

            callType = type;
            setupCallInterface(type);
            document.getElementById('call-status-text').innerText = "Calling...";
            
            // PLAY RINGTONE
            const r = document.getElementById('call-ringtone');
            r.currentTime = 0;
            r.play().catch(e => console.log("Autoplay blocked:", e));

            try {
                const callDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'calls'));
                currentCallId = callDocRef.id;

                localStream = await navigator.mediaDevices.getUserMedia({ video: type === 'video', audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                const remoteStream = new MediaStream();
                document.getElementById('remoteVideo').srcObject = remoteStream;

                peerConnection = new RTCPeerConnection(servers);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = (event) => {
                    event.streams[0].getTracks().forEach(track => {
                        remoteStream.addTrack(track);
                    });
                };

                peerConnection.onicecandidate = async (event) => {
                    if(event.candidate) {
                        const callerCandidatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'callerCandidates');
                        await addDoc(callerCandidatesRef, event.candidate.toJSON());
                    }
                };

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                await setDoc(callDocRef, {
                    caller: currentUser.uid,
                    callerName: document.getElementById('menu-name').innerText,
                    callee: targetUid,
                    callType: type,
                    offer: { type: offer.type, sdp: offer.sdp },
                    status: 'offering',
                    createdAt: serverTimestamp()
                });
                
                logSystemMessage(` Incoming ${type} call`, targetUid);

                unsubscribeCall = onSnapshot(callDocRef, (snap) => {
                    const data = snap.data();
                    if(!data) return;
                    
                    if(!peerConnection.currentRemoteDescription && data.answer) {
                        // ANSWERED - STOP RINGTONE
                        document.getElementById('call-ringtone').pause();
                        
                        const answer = new RTCSessionDescription(data.answer);
                        peerConnection.setRemoteDescription(answer).then(() => {
                             // Now safe to add any queued candidates (implied by snapshot below)
                        });
                        document.getElementById('call-status-text').innerText = "Connected";
                    }
                    
                    if(data.status === 'ended') endCallCleanup();
                });

                // Listen for candidates from Callee - QUEUE logic to prevent race conditions
                const calleeCandidatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'calleeCandidates');
                onSnapshot(calleeCandidatesRef, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const candidate = new RTCIceCandidate(change.doc.data());
                            if (peerConnection.remoteDescription) {
                                peerConnection.addIceCandidate(candidate).catch(e => console.error("Error adding candidate", e));
                            } else {
                                // Simple queue: retry shortly. In prod use a real queue array.
                                setTimeout(() => {
                                     if(peerConnection.remoteDescription) peerConnection.addIceCandidate(candidate).catch(e => console.error(e));
                                }, 1000);
                            }
                        }
                    });
                });
            } catch (err) {
                console.error("Error initiating call:", err);
                alert("Call Failed: Could not access camera/microphone. Ensure you are on HTTPS.");
                endCallCleanup();
            }
        };
        
        function setupCallInterface(type) {
            document.getElementById('call-interface').classList.remove('hidden');
            const icon = document.getElementById('call-icon-indicator');
            const placeholder = document.getElementById('audio-call-placeholder');
            
            if(type === 'audio') {
                icon.className = "fa-solid fa-phone text-green-500 animate-pulse";
                placeholder.classList.remove('hidden');
                document.getElementById('btn-toggle-cam').classList.add('hidden');
            } else {
                icon.className = "fa-solid fa-video text-red-500 animate-pulse";
                placeholder.classList.add('hidden');
                document.getElementById('btn-toggle-cam').classList.remove('hidden');
            }
        }

        window.endCall = async () => {
             if(currentCallId) {
                 try {
                     await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), { status: 'ended' });
                     logSystemMessage("Call ended");
                 } catch(e) {}
             }
             endCallCleanup();
        };

        function endCallCleanup() {
            document.getElementById('call-interface').classList.add('hidden');
            document.getElementById('call-ringtone').pause();
            if(peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if(localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if(unsubscribeCall) unsubscribeCall();
            currentCallId = null;
        }

        window.toggleAudio = () => {
            if(localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                document.getElementById('btn-toggle-mic').classList.toggle('bg-red-500');
                document.getElementById('btn-toggle-mic').classList.toggle('bg-slate-700');
            }
        };

        window.toggleVideo = () => {
             if(localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                videoTrack.enabled = !videoTrack.enabled;
                document.getElementById('btn-toggle-cam').classList.toggle('bg-red-500');
                document.getElementById('btn-toggle-cam').classList.toggle('bg-slate-700');
            }
        };
        
        async function logSystemMessage(text, targetUid = null) {
            let chatId = currentChatId;
            if(!chatId && targetUid) {
                 chatId = [currentUser.uid, targetUid].sort().join('_');
            }
            if(chatId) {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), { 
                    text: text, 
                    type: 'system',
                    senderId: 'system', 
                    createdAt: serverTimestamp() 
                });
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId), {
                    lastUpdated: serverTimestamp()
                }, { merge: true });
            }
        }

        // --- Core Functions ---

        function loadData() {
            if (!currentUser) return;
            
            if (unsubscribePosts) unsubscribePosts();
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'posts'));
            unsubscribePosts = onSnapshot(q, (snap) => {
                const posts = [];
                snap.forEach(d => posts.push({id: d.id, ...d.data()}));
                posts.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                allPostsCache = posts;
                if(!document.getElementById('view-feed').classList.contains('hidden')) renderFeed(posts);
            });

            // UPDATED: Using onSnapshot instead of getDocs for real-time presence
            if(unsubscribeUsers) unsubscribeUsers();
            unsubscribeUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'), (snap) => {
                const u = []; 
                snap.forEach(d => u.push({id: d.id, ...d.data()}));
                allUsersCache = u;
                renderNetwork(u);
                // Also update chat list names/statuses if open
                if(window.allChats.length) renderChatList(window.allChats);
                renderTaggedUsers(); // Ensure tag UI reflects current cache
            });

            onSnapshot(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), (doc) => {
                if(doc.exists()) {
                    const d = doc.data();
                    mySavedPosts = d.savedPosts || [];
                    updateUI(d);
                    if(allPostsCache.length) renderFeed(allPostsCache);
                    // FIXED: Always render if data is ready, router handles visibility
                    renderSavedPosts();
                } else {
                    updateUI({});
                }
            });

            monitorNotifications();
            monitorChats();
            monitorIncomingCalls(); 
        }

        function monitorNotifications() {
            if(unsubscribeNotifications) unsubscribeNotifications();
            const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications'), orderBy('createdAt', 'desc'));
            unsubscribeNotifications = onSnapshot(q, (snap) => {
                allNotifications = [];
                let unreadCount = 0;
                snap.forEach(d => {
                    const n = {id: d.id, ...d.data()};
                    allNotifications.push(n);
                    if(!n.read) unreadCount++;
                });
                const badge = document.getElementById('notification-badge');
                if(badge) badge.style.display = unreadCount > 0 ? 'block' : 'none';
                renderNotificationsList();
            });
        }
        
        function renderNotificationsList() {
            const list = document.getElementById('notification-list');
            if(allNotifications.length === 0) {
                 list.innerHTML = `<p class="text-center text-xs text-slate-400 py-4">No new notifications.</p>`;
                 return;
            }
            list.innerHTML = allNotifications.map(n => {
                let content = '';
                let icon = 'fa-user';
                let iconColor = 'text-blue-500';
                if(n.type === 'like') { content = `liked your post.`; icon = 'fa-heart'; iconColor = 'text-red-500'; }
                else if(n.type === 'comment') { content = `commented on your post.`; icon = 'fa-comment'; }
                else if(n.type === 'follow') { content = `started following you.`; icon = 'fa-user-plus'; }
                else if(n.type === 'mention') { content = `mentioned you in a post.`; icon = 'fa-at'; iconColor = 'text-purple-500'; }
                else if(n.type === 'tag') { content = `tagged you in a post.`; icon = 'fa-tag'; iconColor = 'text-green-500'; } // NEW
                else if (n.type === 'admin_delete') { content = `removed your post for violating guidelines.`; icon = 'fa-trash'; iconColor = 'text-red-600'; } // ADMIN DELETE NOTIF

                return `
                <div class="flex items-start gap-3 p-2 hover:bg-slate-50 rounded-lg cursor-pointer ${n.read ? 'opacity-60' : 'bg-blue-50/50'}" onclick="handleNotificationClick('${n.id}', '${n.type}', '${n.postId || ''}', '${n.fromUid}')">
                    <div class="mt-1"><i class="fa-solid ${icon} ${iconColor}"></i></div>
                    <div>
                        <p class="text-sm text-slate-800"><span class="font-bold">${n.fromName || 'Someone'}</span> ${content}</p>
                        <p class="text-[10px] text-slate-400 mt-1">${n.createdAt ? new Date(n.createdAt.seconds * 1000).toLocaleDateString() : ''}</p>
                    </div>
                </div>`;
            }).join('');
        }
        
        window.handleNotificationClick = async (nid, type, postId, fromUid) => {
             await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications', nid), { read: true });
             if(type === 'like' || type === 'comment' || type === 'mention' || type === 'tag') {
                 router('feed');
                 setTimeout(() => {
                     const postElement = document.getElementById(`post-${postId}-feed`);
                     if (postElement) {
                         postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                         postElement.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2');
                         setTimeout(() => { postElement.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2'); }, 2000);
                     }
                 }, 300);
             } else if (type === 'follow') {
                 viewProfile(fromUid);
             }
             // Admin delete notifications don't need navigation, just marking as read is enough
        };

        function monitorChats() {
            if(unsubscribeChatList) unsubscribeChatList();
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chats'), orderBy('lastUpdated', 'desc'));
            unsubscribeChatList = onSnapshot(q, (snap) => {
                let hasUnread = false;
                const chats = [];
                snap.forEach(d => {
                    const data = d.data();
                    const parts = d.id.split('_');
                    if(parts.includes(currentUser.uid)) {
                        chats.push({id: d.id, ...data});
                        if(data.readBy && !data.readBy.includes(currentUser.uid)) hasUnread = true;
                    }
                });
                const badge = document.getElementById('chat-badge');
                const mobileBadge = document.getElementById('mobile-chat-badge');
                if(badge) badge.style.display = hasUnread ? 'block' : 'none';
                if(mobileBadge) mobileBadge.style.display = hasUnread ? 'block' : 'none';
                window.allChats = chats;
                renderChatList(chats);
            });
        }

        function renderChatList(chats) {
            const container = document.getElementById('chat-list');
            if(chats.length === 0) { container.innerHTML = '<p class="text-center text-xs text-slate-400 mt-4">No chats yet.</p>'; return; }
            container.innerHTML = chats.map(c => {
                const parts = c.id.split('_');
                const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];
                const otherUser = allUsersCache.find(u => u.id === otherUid) || { name: "User", photoURL: "https://placehold.co/100x100" };
                const isUnread = c.readBy && !c.readBy.includes(currentUser.uid);
                
                return `<div onclick="openChat('${c.id}', '${otherUser.name}')" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-white transition-all ${c.id === currentChatId ? 'bg-white shadow-sm ring-1 ring-slate-100' : 'hover:shadow-sm'} ${isUnread ? 'bg-blue-50/50' : ''}">
                    <div class="relative">
                        <img src="${otherUser.photoURL}" class="w-10 h-10 rounded-full bg-slate-200 object-cover">
                        ${isUnread ? '<div class="absolute top-0 right-0 w-3 h-3 bg-blue-500 rounded-full border-2 border-white"></div>' : ''}
                    </div>
                    <div class="truncate flex-grow">
                        <h4 class="font-bold text-sm text-slate-800 ${isUnread ? 'text-black' : ''}">${otherUser.name}</h4>
                        ${isUnread ? '<p class="text-[10px] text-blue-600 font-bold">New message</p>' : ''}
                    </div>
                </div>`;
            }).join('');
        }

        window.openChat = async (chatId, name) => {
            currentChatId = chatId;
            // Removed the line causing the sidebar to clear: renderChatList([])
            if(window.allChats) renderChatList(window.allChats);
            
            document.querySelector('#chat-header span').innerText = name;
            document.getElementById('start-video-call-btn').classList.remove('hidden');
            document.getElementById('start-audio-call-btn').classList.remove('hidden');
            document.getElementById('delete-chat-btn').classList.remove('hidden');

            const input = document.getElementById('message-input');
            const btn = document.getElementById('message-send-btn');
            input.disabled = false;
            btn.disabled = false;
            input.focus();

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId), {
                readBy: arrayUnion(currentUser.uid)
            }, { merge: true });

            if(unsubscribeMessages) unsubscribeMessages();
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), orderBy('createdAt', 'asc'));
            unsubscribeMessages = onSnapshot(q, (snap) => {
                const c = document.getElementById('chat-messages');
                c.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    if(m.type === 'system') {
                        c.innerHTML += `<div class="msg-system">${m.text}</div>`;
                        return;
                    }
                    const me = m.senderId === currentUser.uid;
                    c.innerHTML += `<div class="flex w-full mb-2 ${me?'justify-end':'justify-start'}"><div class="msg-bubble ${me?'msg-me':'msg-them'} shadow-sm">${m.text}</div></div>`;
                });
                c.scrollTop = c.scrollHeight;
            });
            router('messaging');
            
            if(window.innerWidth < 768) {
                document.getElementById('msg-list-col').classList.add('hidden');
                document.getElementById('msg-chat-col').classList.remove('hidden');
                document.getElementById('msg-chat-col').classList.add('flex');
            }
        };
        
        window.backToChatList = () => {
             document.getElementById('msg-list-col').classList.remove('hidden');
             document.getElementById('msg-chat-col').classList.add('hidden');
             document.getElementById('msg-chat-col').classList.remove('flex');
             currentChatId = null;
        };
        
        window.deleteChat = async () => {
            if(!confirm("Delete this conversation?")) return;
            const s = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId, 'messages'));
            s.docs.forEach(d => deleteDoc(d.ref));
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId));
            
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('start-video-call-btn').classList.add('hidden');
            document.getElementById('start-audio-call-btn').classList.add('hidden');
            document.getElementById('delete-chat-btn').classList.add('hidden');
            document.querySelector('#chat-header span').innerText = "Select a conversation";
            currentChatId = null;
            
            if(window.innerWidth < 768) backToChatList();
        };

        window.sendMessage = async (e) => {
            e.preventDefault(); const i = document.getElementById('message-input'); if(!i.value.trim()) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId, 'messages'), { text: i.value, senderId: currentUser.uid, createdAt: serverTimestamp() });
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId), {
                lastUpdated: serverTimestamp(),
                readBy: [currentUser.uid]
            }, { merge: true });
            i.value = '';
        };

        // --- Router & UI Helpers ---

        window.router = (view) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            const navLink = document.getElementById(`nav-link-${view}`);
            if(navLink) navLink.classList.add('active');
            
            // FIXED: Force re-render of saved posts when view is accessed
            if(view === 'saved') renderSavedPosts();
            
            if(view === 'messaging' && window.innerWidth < 768 && !currentChatId) {
                 backToChatList();
            }
            
            window.scrollTo(0,0);
        };
        
        window.handleGoogleAuth = () => {
             const provider = new GoogleAuthProvider();
             signInWithPopup(auth, provider).catch(e => document.getElementById('auth-error').innerText = e.message);
        };
        
        window.handleEmailAuth = async () => {
             const email = document.getElementById('auth-email').value;
             const pass = document.getElementById('auth-password').value;
             try {
                 await signInWithEmailAndPassword(auth, email, pass);
             } catch(e) {
                 try {
                     await createUserWithEmailAndPassword(auth, email, pass);
                 } catch(err) {
                     document.getElementById('auth-error').innerText = err.message;
                     document.getElementById('auth-error').classList.remove('hidden');
                 }
             }
        };

        window.handleSignOut = () => signOut(auth);

        function updateUI(data) {
             const user = currentUser;
             const name = data.name || user.displayName || user.email.split('@')[0] || "User";
             const pic = data.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`;
             const headline = data.headline || ""; // Empty default

             document.getElementById('nav-avatar').src = pic;
             document.getElementById('sidebar-mini-avatar').src = pic;
             document.getElementById('menu-avatar-small').src = pic;
             document.getElementById('composer-avatar').src = pic;
             document.getElementById('modal-avatar').src = pic;
             
             document.getElementById('sidebar-mini-name').innerText = name;
             document.getElementById('menu-name').innerText = name;
             document.getElementById('composer-name-placeholder').innerText = name.split(' ')[0];
             
             document.getElementById('settings-username').value = name;
             document.getElementById('edit-headline').value = headline;
             document.getElementById('edit-bio').value = data.bio || "";
             document.getElementById('edit-modal-avatar').src = pic;
        }

        // --- Post Rendering ---
        
        // Updated Save Function with Optimistic UI & View Refresh
        window.savePost = async (postId) => {
             // 1. Determine current state
             const isSaved = mySavedPosts.includes(postId);
             
             // 2. Optimistic Local Update
             if(isSaved) {
                 const idx = mySavedPosts.indexOf(postId);
                 if (idx > -1) mySavedPosts.splice(idx, 1);
             } else {
                 mySavedPosts.push(postId);
             }
             
             // 3. Render UI Immediately
             // This handles the specific button clicked without re-rendering the whole list yet
             const btnIcons = document.querySelectorAll(`#post-${postId}-feed .fa-bookmark, #post-${postId}-saved .fa-bookmark, #post-${postId}-profile .fa-bookmark`);
             btnIcons.forEach(btnIcon => {
                 if(isSaved) { // Removing
                     btnIcon.classList.remove('fa-solid', 'text-purple-600');
                     btnIcon.classList.add('fa-regular');
                 } else { // Adding
                     btnIcon.classList.remove('fa-regular');
                     btnIcon.classList.add('fa-solid', 'text-purple-600');
                 }
                 // Update Text if present (in menu)
                 const btnText = btnIcon.parentElement; 
                 if(btnText && btnText.innerText.includes('Save')) {
                     btnText.innerText = isSaved ? 'Save' : 'Unsave'; // Inverse logic because we just toggled
                 }
             });
             
             if(!document.getElementById('view-saved').classList.contains('hidden')) {
                 renderSavedPosts();
             }

             // 4. Perform Database Operation (Background)
             const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
             try {
                 if(isSaved) {
                     await updateDoc(userRef, { savedPosts: arrayRemove(postId) });
                 } else {
                     await updateDoc(userRef, { savedPosts: arrayUnion(postId) });
                 }
             } catch(e) {
                 console.error("Save failed", e);
                 // Revert if failed
                 if(isSaved) mySavedPosts.push(postId); 
                 else { 
                     const idx = mySavedPosts.indexOf(postId);
                     if(idx > -1) mySavedPosts.splice(idx, 1);
                 }
                 renderFeed(allPostsCache);
                 renderSavedPosts();
             }
        };

        function createPostHTML(post, context) {
            const isProject = post.type === 'project';
            const tags = post.tags ? post.tags.map(t => `<span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md">#${t}</span>`).join('') : '';
            const hasLiked = post.likedBy && post.likedBy.includes(currentUser.uid);
            const isSaved = mySavedPosts.includes(post.id);
            const likeIconClass = hasLiked ? "fa-solid text-blue-600" : "fa-regular";
            const saveIconClass = isSaved ? "fa-solid text-purple-600" : "fa-regular";
            const saveText = isSaved ? "Unsave" : "Save";
            
            let taggedHTML = '';
            if(post.taggedUsers && post.taggedUsers.length > 0) {
                const names = post.taggedUsers.map(u => `<span class="font-bold hover:underline cursor-pointer" onclick="viewProfile('${u.id}')">${u.name}</span>`).join(', ');
                taggedHTML = ` <span class="text-slate-500 font-normal">is with ${names}</span>`;
            }
            
            // Admin Check (Case Insensitive)
            const isAdmin = currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            const canDelete = currentUser.uid === post.uid || isAdmin;
            const canEdit = currentUser.uid === post.uid;

            // Determine if post author is admin
            const postAuthorIsAdmin = allUsersCache.find(u => u.id === post.uid)?.isAdmin;
            const adminBadge = postAuthorIsAdmin ? `<span class="admin-badge">Admin ★</span>` : '';

            return `<div id="post-${post.id}-${context}" class="glass-card rounded-2xl bg-white p-0 overflow-hidden animate-fade-in mb-4">
                <div class="p-4 flex gap-3">
                    <img src="${post.photoURL}" class="w-10 h-10 rounded-full bg-slate-100 object-cover cursor-pointer" onclick="viewProfile('${post.uid}')">
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">
                                    <span class="hover:underline cursor-pointer" onclick="viewProfile('${post.uid}')">${post.name}</span>${adminBadge}${taggedHTML}
                                </h4>
                                <p class="text-xs text-slate-400">${post.headline || 'Member'}</p>
                            </div>
                            <div class="relative">
                                <button onclick="toggleMenu('${post.id}', '${context}')" class="text-slate-400 hover:bg-slate-100 w-8 h-8 rounded-full"><i class="fa-solid fa-ellipsis"></i></button>
                                <div id="menu-${post.id}-${context}" class="hidden absolute right-0 top-8 bg-white shadow-xl border border-slate-100 rounded-xl py-2 w-32 z-10">
                                    <button onclick="savePost('${post.id}')" class="w-full text-left px-4 py-2 text-slate-600 hover:bg-slate-50 text-sm font-medium">${saveText}</button>
                                    ${canEdit ? `<button onclick="editPost('${post.id}')" class="w-full text-left px-4 py-2 text-slate-600 hover:bg-slate-50 text-sm font-medium">Edit</button>` : ''}
                                    ${canDelete ? `<button onclick="initiateDelete('${post.id}', '${post.uid}')" class="w-full text-left px-4 py-2 text-red-500 hover:bg-red-50 text-sm font-bold">Delete</button>` : ''}
                                    <button onclick="reportPost('${post.id}', '${post.uid}')" class="w-full text-left px-4 py-2 text-orange-500 hover:bg-orange-50 text-sm font-medium">Report</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="px-4 pb-2">
                    ${isProject ? '<span class="inline-block bg-gradient-to-r from-blue-600 to-purple-600 text-white text-[10px] font-bold px-2 py-1 rounded-full mb-2"><i class="fa-solid fa-rocket mr-1"></i> PROJECT</span>' : ''}
                    <p class="text-slate-700 text-sm whitespace-pre-line leading-relaxed">${post.text}</p>
                    <div class="mt-2 flex flex-wrap gap-2">${tags}</div>
                </div>
                ${post.attachment ? `<div class="mt-2"><img src="${post.attachment}" class="w-full object-cover max-h-[500px] bg-slate-50"></div>` : ''}
                <div class="px-4 py-3 border-t border-slate-100 flex gap-1">
                    <button onclick="toggleLike('${post.id}')" class="flex-1 py-2 rounded-lg hover:bg-slate-50 transition-colors flex items-center justify-center gap-2 text-slate-500 font-medium text-sm"><i class="${likeIconClass} fa-heart text-lg"></i> <span class="${hasLiked ? 'text-blue-600' : ''}">${post.likes || 0}</span></button>
                    <button onclick="toggleCommentSection('${post.id}', '${context}')" class="flex-1 py-2 rounded-lg hover:bg-slate-50 transition-colors flex items-center justify-center gap-2 text-slate-500 font-medium text-sm"><i class="fa-regular fa-comment text-lg"></i></button>
                    <button onclick="savePost('${post.id}')" class="flex-1 py-2 rounded-lg hover:bg-slate-50 transition-colors flex items-center justify-center gap-2 text-slate-500 font-medium text-sm"><i class="${saveIconClass} fa-bookmark text-lg"></i></button>
                </div>
                 <div id="comments-${post.id}-${context}" class="hidden mt-0 bg-slate-50/50 p-4 border-t border-slate-100">
                    <div id="comments-list-${post.id}-${context}" class="space-y-3 mb-3 max-h-60 overflow-y-auto custom-scrollbar"></div>
                    <div class="flex gap-2 items-center">
                        <img src="${document.getElementById('nav-avatar').src}" class="w-8 h-8 rounded-full">
                        <div class="flex-grow bg-white border border-slate-200 rounded-full px-4 py-2 flex items-center shadow-sm">
                            <input type="text" id="comment-input-${post.id}-${context}" placeholder="Write a comment..." class="bg-transparent w-full text-sm outline-none" onkeydown="if(event.key==='Enter') submitComment('${post.id}', '${context}')">
                            <button onclick="submitComment('${post.id}', '${context}')" class="text-blue-600 ml-2 hover:bg-blue-50 p-1 rounded-full"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        window.renderFeed = (posts) => {
             const container = document.getElementById('feed-stream');
             if(!posts.length) { container.innerHTML = `<div class="text-center py-12 text-slate-400">No posts yet.</div>`; return; }
             container.innerHTML = posts.map(p => createPostHTML(p, 'feed')).join('');
        };
        
        window.renderSavedPosts = () => {
             const container = document.getElementById('saved-posts-stream');
             const saved = allPostsCache.filter(p => mySavedPosts.includes(p.id));
             if(!saved.length) { container.innerHTML = `<p class="text-center text-slate-400 py-8">No saved posts.</p>`; return; }
             container.innerHTML = saved.map(p => createPostHTML(p, 'saved')).join('');
        };

        function renderNetwork(users) {
            const g = document.getElementById('network-grid');
            if(!users.length) { 
                if(currentUser) {
                     g.innerHTML = `<p class="col-span-2 text-center text-slate-400">Initializing your network...</p>`;
                     return;
                }
                g.innerHTML = `<p class="col-span-2 text-center text-slate-400">No users found.</p>`; 
                return; 
            }
            // MODIFIED: Inner div handles profile view, outer button handles chat
            g.innerHTML = users.map(u => `
            <div class="glass-card rounded-xl p-4 flex items-center gap-4 hover:border-blue-300 transition-colors">
                <div class="flex items-center gap-4 flex-grow cursor-pointer" onclick="viewProfile('${u.id}')">
                    <img src="${u.photoURL}" class="w-12 h-12 rounded-full bg-slate-100 object-cover">
                    <div>
                        <h4 class="font-bold text-slate-800 text-sm">${u.name}</h4>
                        <p class="text-xs text-slate-500 truncate">${u.headline || 'Member'}</p>
                    </div>
                </div>
                <button onclick="startChat('${u.id}', '${u.name}')" class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 transition-colors z-10" title="Message">
                    <i class="fa-regular fa-comment-dots"></i>
                </button>
            </div>`).join('');
        }

        window.startChat = async (uid, name) => {
            if(uid === currentUser.uid) return;
            const chatId = [currentUser.uid, uid].sort().join('_');
            const chatRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId);
            const chatSnap = await getDoc(chatRef);
            
            if(!chatSnap.exists()) {
                await setDoc(chatRef, {
                    createdAt: serverTimestamp(),
                    lastUpdated: serverTimestamp(),
                    participants: [currentUser.uid, uid],
                    readBy: [currentUser.uid]
                });
            }
            
            openChat(chatId, name);
        };

        // --- Standard Actions ---
        
        window.toggleLike = async (postId) => {
             const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId);
             const p = allPostsCache.find(x => x.id === postId);
             if(!p) return;
             const hasLiked = p.likedBy && p.likedBy.includes(currentUser.uid);
             
             if(hasLiked) {
                 await updateDoc(postRef, { likes: increment(-1), likedBy: arrayRemove(currentUser.uid) });
             } else {
                 await updateDoc(postRef, { likes: increment(1), likedBy: arrayUnion(currentUser.uid) });
                 if(p.uid !== currentUser.uid) {
                      addDoc(collection(db, 'artifacts', appId, 'users', p.uid, 'notifications'), {
                          type: 'like', postId: postId, fromUid: currentUser.uid, fromName: document.getElementById('menu-name').innerText, read: false, createdAt: serverTimestamp()
                      });
                 }
             }
        };

        window.toggleMenu = (pid, ctx) => document.getElementById(`menu-${pid}-${ctx}`).classList.toggle('hidden');
        
        window.toggleCommentSection = (pid, ctx) => {
            const el = document.getElementById(`comments-${pid}-${ctx}`);
            el.classList.toggle('hidden');
            if(!el.classList.contains('hidden')) loadComments(pid, ctx);
        };

        window.loadComments = (pid, ctx) => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'posts', pid, 'comments'), orderBy('createdAt', 'asc'));
            onSnapshot(q, (snap) => {
                const list = document.getElementById(`comments-list-${pid}-${ctx}`);
                list.innerHTML = '';
                snap.forEach(d => {
                    const c = d.data();
                    list.innerHTML += `<div class="flex gap-2"><img src="${c.photoURL}" class="w-6 h-6 rounded-full mt-1"><div class="bg-white p-2 rounded-r-xl rounded-bl-xl shadow-sm border border-slate-100 text-sm"><p class="font-bold text-xs text-slate-800">${c.name}</p><p class="text-slate-600">${c.text}</p></div></div>`;
                });
                list.scrollTop = list.scrollHeight;
            });
        };

        window.submitComment = async (pid, ctx) => {
            const inp = document.getElementById(`comment-input-${pid}-${ctx}`);
            if(!inp.value.trim()) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts', pid, 'comments'), {
                text: inp.value,
                uid: currentUser.uid,
                name: document.getElementById('menu-name').innerText,
                photoURL: document.getElementById('nav-avatar').src,
                createdAt: serverTimestamp()
            });
            const p = allPostsCache.find(x => x.id === pid);
            if(p && p.uid !== currentUser.uid) {
                 addDoc(collection(db, 'artifacts', appId, 'users', p.uid, 'notifications'), {
                      type: 'comment', postId: pid, fromUid: currentUser.uid, fromName: document.getElementById('menu-name').innerText, read: false, createdAt: serverTimestamp()
                 });
            }
            inp.value = '';
        };

        // --- NEW: Tag People Functions ---
        window.toggleTagUserPicker = () => {
            const picker = document.getElementById('user-tag-picker');
            picker.classList.toggle('hidden');
            if(!picker.classList.contains('hidden')) {
                // Populate picker with cached users
                const list = document.getElementById('user-tag-list');
                list.innerHTML = allUsersCache.map(u => `
                    <div class="flex items-center gap-2 p-1 hover:bg-slate-50 cursor-pointer" onclick="toggleUserTag('${u.id}', '${u.name}')">
                        <img src="${u.photoURL}" class="w-6 h-6 rounded-full">
                        <span class="text-xs font-bold text-slate-700 truncate">${u.name}</span>
                        ${window.taggedUsers.find(t => t.id === u.id) ? '<i class="fa-solid fa-check text-green-500 ml-auto"></i>' : ''}
                    </div>
                `).join('');
            }
        };

        window.toggleUserTag = (uid, name) => {
            const existing = window.taggedUsers.findIndex(t => t.id === uid);
            if(existing > -1) {
                window.taggedUsers.splice(existing, 1);
            } else {
                window.taggedUsers.push({id: uid, name: name});
            }
            renderTaggedUsers();
            toggleTagUserPicker(); // Refresh list
        };

        function renderTaggedUsers() {
             const container = document.getElementById('tagged-users-display');
             if(window.taggedUsers.length === 0) {
                 container.classList.add('hidden');
                 container.innerHTML = '';
                 return;
             }
             container.classList.remove('hidden');
             container.innerHTML = window.taggedUsers.map(t => `
                 <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                    @${t.name} 
                    <i class="fa-solid fa-xmark cursor-pointer hover:text-blue-900" onclick="toggleUserTag('${t.id}', '${t.name}')"></i>
                 </span>
             `).join('');
        }

        // --- Edit Post Functions ---
        window.editPost = (pid) => {
            const p = allPostsCache.find(x => x.id === pid);
            if(!p) return;
            
            // Set Global Edit Mode
            editModeId = pid;
            
            // Populate Modal
            document.getElementById('modal-title').innerText = "Edit Post";
            document.getElementById('post-input').value = p.text || "";
            document.getElementById('post-submit-btn').innerText = "Update Post";
            
            // Handle type
            const typeSelect = document.getElementById('post-type-select');
            typeSelect.value = p.type || 'regular';
            if(p.type === 'project') {
                document.getElementById('project-tags-input').classList.remove('hidden');
                document.getElementById('tags-input').value = (p.tags || []).join(', ');
            }
            
            // Handle attachment
            if(p.attachment) {
                 currentAttachment = p.attachment;
                 document.getElementById('preview-img').src = currentAttachment;
                 document.getElementById('attachment-preview').classList.remove('hidden');
            }
            
            // Handle Tagged Users
            window.taggedUsers = p.taggedUsers || [];
            renderTaggedUsers();
            
            // Show Modal
            document.getElementById('post-modal').classList.remove('hidden');
        };

        window.openPostModal = (type='regular') => {
             // Clear Edit Mode
             editModeId = null;
             currentAttachment = null;
             window.taggedUsers = [];
             renderTaggedUsers();
             document.getElementById('attachment-preview').classList.add('hidden');
             document.getElementById('modal-title').innerText = "Create Post";
             document.getElementById('post-submit-btn').innerText = "Post";
             document.getElementById('post-input').value = "";
             document.getElementById('project-tags-input').classList.add('hidden');
             
             document.getElementById('post-modal').classList.remove('hidden');
             if(type === 'project') document.getElementById('post-type-select').value = 'project';
             document.getElementById('post-input').focus();
        };
        
        window.closePostModal = () => document.getElementById('post-modal').classList.add('hidden');
        
        window.submitPost = async () => {
             const text = document.getElementById('post-input').value;
             const type = document.getElementById('post-type-select').value;
             
             if(!text.trim() && !currentAttachment) return;
             
             const userHeadline = document.getElementById('edit-headline').value || "Member";

             closePostModal();
             
             const postData = {
                 text: text,
                 type: type,
                 uid: currentUser.uid,
                 name: document.getElementById('menu-name').innerText,
                 photoURL: document.getElementById('nav-avatar').src,
                 headline: userHeadline, 
                 attachment: currentAttachment,
                 taggedUsers: window.taggedUsers,
                 tags: type==='project'? document.getElementById('tags-input').value.split(',').map(s=>s.trim().replace('#','')).filter(s=>s) : [],
                 lastEdited: serverTimestamp()
             };

             if (editModeId) {
                 // Update Existing
                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', editModeId), postData);
                 editModeId = null; // Reset
             } else {
                 // Create New
                 postData.likes = 0;
                 postData.createdAt = serverTimestamp();
                 const newPostRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), postData);
                 
                 // Send Notifications to Tagged Users
                 if(window.taggedUsers.length > 0) {
                     window.taggedUsers.forEach(u => {
                         if(u.id !== currentUser.uid) {
                             addDoc(collection(db, 'artifacts', appId, 'users', u.id, 'notifications'), {
                                type: 'tag',
                                fromUid: currentUser.uid,
                                fromName: currentUser.displayName,
                                postId: newPostRef.id,
                                read: false,
                                createdAt: serverTimestamp()
                             });
                         }
                     });
                 }
             }

             document.getElementById('post-input').value = '';
             currentAttachment = null;
             window.taggedUsers = [];
             document.getElementById('attachment-preview').classList.add('hidden');
        };

        let postToDeleteOwnerUid = null;

        window.initiateDelete = (pid, ownerUid) => {
            postToDeleteId = pid;
            postToDeleteOwnerUid = ownerUid;
            document.getElementById('delete-modal').classList.remove('hidden', 'opacity-0');
        };

        window.closeDeleteModal = () => {
            postToDeleteId = null;
            postToDeleteOwnerUid = null;
            document.getElementById('delete-modal').classList.add('hidden', 'opacity-0');
        };

        // Updated delete logic for Admin notifications
        window.executeDelete = async () => {
             if(postToDeleteId) {
                 await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', postToDeleteId));
                 
                 // Check if Admin is deleting someone else's post
                 if(currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase() && postToDeleteOwnerUid !== currentUser.uid) {
                     await addDoc(collection(db, 'artifacts', appId, 'users', postToDeleteOwnerUid, 'notifications'), {
                        type: 'admin_delete',
                        fromUid: 'admin',
                        fromName: 'Lumini Admin',
                        read: false,
                        createdAt: serverTimestamp()
                     });
                 }
             }
             closeDeleteModal();
        };

        window.confirmDelete = window.executeDelete; // Map modal button to execution function

        window.handleFileSelect = (input) => {
             if(input.files && input.files[0]) {
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     currentAttachment = e.target.result;
                     document.getElementById('preview-img').src = currentAttachment;
                     document.getElementById('attachment-preview').classList.remove('hidden');
                 };
                 reader.readAsDataURL(input.files[0]);
             }
        };
        
        window.clearAttachment = () => {
            currentAttachment = null;
            document.getElementById('file-input').value = '';
            document.getElementById('attachment-preview').classList.add('hidden');
        };

        window.viewMyProfile = () => { if(currentUser) viewProfile(currentUser.uid); };
        window.viewProfile = async (uid) => {
             window.currentViewedUid = uid; // Set global tracking var
             
             let user = allUsersCache.find(u => u.id === uid);
             if(!user && uid === currentUser.uid) {
                 user = { name: "Me", photoURL: document.getElementById('nav-avatar').src, headline: "My Headline" };
             } else if (!user) {
                 const uDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', uid));
                 if(uDoc.exists()) {
                     user = uDoc.data();
                 } else {
                     user = { name: "Unknown User", photoURL: "https://placehold.co/100x100" };
                 }
             }
             
             document.getElementById('profile-page-name').innerText = user ? user.name : "User";
             document.getElementById('profile-page-avatar').src = user ? user.photoURL : "https://placehold.co/100x100";
             document.getElementById('profile-page-headline').innerText = user ? (user.headline || "") : "";
             
             // --- SHOW JOINED DATE ---
             const dateSpan = document.getElementById('profile-join-date');
             if (user.createdAt) {
                 const date = new Date(user.createdAt.seconds * 1000);
                 dateSpan.innerText = date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
             } else {
                 dateSpan.innerText = "Unknown";
             }

             // Handle Buttons
             if(uid === currentUser.uid) {
                 document.getElementById('edit-profile-btn').classList.remove('hidden');
                 document.getElementById('follow-btn').classList.add('hidden');
                 document.getElementById('profile-chat-btn').classList.add('hidden');
             } else {
                 document.getElementById('edit-profile-btn').classList.add('hidden');
                 document.getElementById('follow-btn').classList.remove('hidden');
                 document.getElementById('profile-chat-btn').classList.remove('hidden');
                 document.getElementById('profile-chat-btn').onclick = () => startChat(uid, user.name);
             }
             
             // Fetch Profile Specifics (Followers/Following/Bio)
             const pDoc = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'profile', 'main'));
             
             let followerCount = 0;
             let followingCount = 0;
             
             if(pDoc.exists()) {
                 const d = pDoc.data();
                 document.getElementById('profile-page-bio').innerText = d.bio || "No bio yet.";
                 document.getElementById('profile-full-bio').innerText = d.bio || "No details available.";
                 followerCount = (d.followers || []).length;
                 followingCount = (d.following || []).length;
                 
                 // Set Follow Button State
                 if(uid !== currentUser.uid) {
                     // Check if *I* am following *them* (check my own following list)
                     const myRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
                     const mySnap = await getDoc(myRef);
                     const isFollowing = mySnap.exists() && (mySnap.data().following || []).includes(uid);
                     
                     const btn = document.getElementById('follow-btn');
                     const btnText = btn.querySelector('span');
                     if(isFollowing) {
                        btnText.innerText = "Unfollow";
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('bg-slate-200', 'text-slate-700');
                     } else {
                        btnText.innerText = "Follow";
                        btn.classList.remove('bg-slate-200', 'text-slate-700');
                        btn.classList.add('bg-blue-600', 'text-white');
                     }
                 }
                 
             } else {
                 document.getElementById('profile-page-bio').innerText = "No bio yet.";
                 document.getElementById('profile-full-bio').innerText = "No details available.";
             }
             
             document.getElementById('profile-followers-count').innerText = followerCount;
             document.getElementById('profile-following-count').innerText = followingCount;
             
             // ADMIN CONTROL
             if (currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase() && uid !== currentUser.uid) {
                 const isBanned = user.isBanned || false;
                 let adminControls = document.getElementById('admin-controls-container');
                 adminControls.innerHTML = `
                     <div class="mt-4 pt-4 border-t border-red-100">
                         <h4 class="text-xs font-bold text-red-500 uppercase mb-2">Admin Controls</h4>
                         <button onclick="toggleBan('${uid}', ${isBanned})" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold text-xs hover:bg-red-200 transition-colors">
                             ${isBanned ? 'Unban User' : 'Ban User'}
                         </button>
                     </div>
                 `;
             } else {
                 document.getElementById('admin-controls-container').innerHTML = '';
             }

             const userPosts = allPostsCache.filter(p => p.uid === uid);
             document.getElementById('profile-content-posts').innerHTML = userPosts.length ? userPosts.map(p => createPostHTML(p, 'profile')).join('') : '<p class="text-center text-slate-400 py-8">No posts yet.</p>';
             
             router('profile');
        };

        window.openSettingsModal = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.closeSettingsModal = () => document.getElementById('settings-modal').classList.add('hidden');
        
        window.saveSettings = async () => {
             const newName = document.getElementById('settings-username').value;
             if(newName) {
                 await updateProfile(currentUser, { displayName: newName });
                 await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid), {
                     name: newName,
                     photoURL: currentUser.photoURL,
                     headline: document.getElementById('edit-headline').value
                 }, { merge: true });
                 location.reload();
             }
        };

        window.openEditProfileModal = () => document.getElementById('edit-profile-modal').classList.remove('hidden');
        window.closeEditProfileModal = () => document.getElementById('edit-profile-modal').classList.add('hidden');
        
        window.saveProfileData = async () => {
             const headline = document.getElementById('edit-headline').value;
             const bio = document.getElementById('edit-bio').value;
             
             await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), {
                 headline, bio, savedPosts: mySavedPosts
             }, { merge: true });
             
             await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid), {
                 name: currentUser.displayName,
                 photoURL: currentUser.photoURL,
                 headline: headline
             }, { merge: true });
             
             closeEditProfileModal();
             viewMyProfile();
        };

        window.handlePfpChange = (input) => {
             if(input.files && input.files[0]) {
                 const reader = new FileReader();
                 reader.onload = async (e) => {
                     const dataUrl = e.target.result;
                     await updateProfile(currentUser, { photoURL: dataUrl });
                     await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid), { photoURL: dataUrl }, { merge: true });
                     document.getElementById('edit-modal-avatar').src = dataUrl;
                 };
                 reader.readAsDataURL(input.files[0]);
             }
        };

        window.switchProfileTab = (tab) => {
             document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
             document.getElementById(`tab-${tab}`).classList.add('active');
             
             if(tab === 'posts') {
                 document.getElementById('profile-content-posts').classList.remove('hidden');
                 document.getElementById('profile-content-about').classList.add('hidden');
                 document.getElementById('profile-content-saved').classList.add('hidden');
             } else if(tab === 'about') {
                 document.getElementById('profile-content-posts').classList.add('hidden');
                 document.getElementById('profile-content-about').classList.remove('hidden');
                 document.getElementById('profile-content-saved').classList.add('hidden');
             } else {
                 document.getElementById('profile-content-posts').classList.add('hidden');
                 document.getElementById('profile-content-about').classList.add('hidden');
                 document.getElementById('profile-content-saved').classList.remove('hidden');
             }
        };
        
        window.toggleProfileMenu = () => document.getElementById('profile-menu').classList.toggle('hidden');
        window.toggleNotificationDropdown = () => document.getElementById('notification-dropdown').classList.toggle('hidden');
        
        window.handleSearch = (val) => {
             const dropdown = document.getElementById('search-dropdown');
             if(!val.trim()) { dropdown.classList.add('hidden'); return; }
             
             const matches = allUsersCache.filter(u => u.name.toLowerCase().includes(val.toLowerCase()));
             dropdown.classList.remove('hidden');
             if(!matches.length) { dropdown.innerHTML = `<p class="p-4 text-xs text-slate-400">No users found.</p>`; return; }
             
             dropdown.innerHTML = matches.map(u => `<div onclick="viewProfile('${u.id}')" class="flex items-center gap-3 p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-50"><img src="${u.photoURL}" class="w-8 h-8 rounded-full bg-slate-200"><span class="font-bold text-sm text-slate-700">${u.name}</span></div>`).join('');
        };
        
        window.toggleEmojiPicker = () => document.getElementById('emoji-picker').classList.toggle('hidden');
        window.insertEmoji = (e) => { document.getElementById('post-input').value += e; };
        window.toggleTagPicker = () => {
             const p = document.getElementById('tag-picker');
             p.classList.toggle('hidden');
             if(!p.classList.contains('hidden')) {
                  document.getElementById('tag-list').innerHTML = `
                  <div class="p-1 hover:bg-slate-50 cursor-pointer text-xs font-bold text-slate-600" onclick="addTag('javascript')">#javascript</div>
                  <div class="p-1 hover:bg-slate-50 cursor-pointer text-xs font-bold text-slate-600" onclick="addTag('design')">#design</div>
                  <div class="p-1 hover:bg-slate-50 cursor-pointer text-xs font-bold text-slate-600" onclick="addTag('react')">#react</div>
                  <div class="p-1 hover:bg-slate-50 cursor-pointer text-xs font-bold text-slate-600" onclick="addTag('firebase')">#firebase</div>
                  `;
             }
        };
        window.addTag = (t) => {
             const el = document.getElementById('post-type-select');
             if(el.value !== 'project') { el.value = 'project'; document.getElementById('project-tags-input').classList.remove('hidden'); }
             const i = document.getElementById('tags-input');
             i.value = i.value ? i.value + ', ' + t : t;
             document.getElementById('tag-picker').classList.add('hidden');
        };

        // Close menus on click outside
        document.addEventListener('click', (e) => {
            if(!e.target.closest('.relative')) {
                document.getElementById('profile-menu').classList.add('hidden');
                document.getElementById('notification-dropdown').classList.add('hidden');
                document.getElementById('emoji-picker').classList.add('hidden');
                document.getElementById('tag-picker').classList.add('hidden');
                document.getElementById('user-tag-picker').classList.add('hidden');
            }
        });

        // --- UPDATED: Clear Notifications & Report Logic with Modals ---
        
        // Clear Notifications Logic
        window.openClearNotifsModal = () => {
            if(allNotifications.length === 0) return;
            document.getElementById('clear-notifs-modal').classList.remove('hidden');
        };

        window.closeClearNotifsModal = () => {
            document.getElementById('clear-notifs-modal').classList.add('hidden');
        };

        window.executeClearNotifs = async () => {
            closeClearNotifsModal();
            try {
                const batch = writeBatch(db);
                const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications'));
                const snap = await getDocs(q);
                
                snap.forEach(d => {
                    batch.delete(d.ref);
                });
                
                await batch.commit();
            } catch(e) {
                console.error("Error clearing notifications:", e);
                alert("Failed to clear notifications.");
            }
        };
        
        window.clearAllNotifications = window.openClearNotifsModal;

        // Report Logic
        let reportTargetPostId = null;
        let reportTargetUid = null;

        window.reportPost = (postId, postUid) => {
             reportTargetPostId = postId;
             reportTargetUid = postUid;
             document.getElementById('report-reason').value = ""; // Clear previous input
             document.getElementById('report-modal').classList.remove('hidden');
        };

        window.closeReportModal = () => {
             document.getElementById('report-modal').classList.add('hidden');
             reportTargetPostId = null;
             reportTargetUid = null;
        };

        window.submitReport = async () => {
             const reason = document.getElementById('report-reason').value;
             if (!reason.trim()) {
                 alert("Please provide a reason for the report.");
                 return;
             }

             // Gather data
             const targetUser = allUsersCache.find(u => u.id === reportTargetUid);
             const targetName = targetUser ? targetUser.name : "Unknown User";
             const postLink = window.location.origin + window.location.pathname + "#post-" + reportTargetPostId;

             try {
                 await addDoc(collection(db, 'artifacts', appId, 'reports'), {
                     reporterUid: currentUser.uid,
                     reporterName: currentUser.displayName,
                     reporterEmail: currentUser.email,
                     targetUid: reportTargetUid,
                     targetName: targetName,
                     postId: reportTargetPostId,
                     reason: reason,
                     postLink: postLink,
                     createdAt: serverTimestamp(),
                     status: 'pending' // pending review
                 });
                 alert("Report submitted to admins.");
             } catch (e) {
                 console.error("Error submitting report:", e);
                 alert("Failed to submit report.");
             }

             closeReportModal();
        };

    </script>
</body>
</html>
